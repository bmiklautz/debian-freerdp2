From dd415320b78e6f703680aee64f9297909bd34f5e Mon Sep 17 00:00:00 2001
From: Bernhard Miklautz <bernhard.miklautz@thincast.com>
Date: Wed, 14 Mar 2018 16:58:50 +0100
Subject: [PATCH] fix nla: don't use server version

based on upstream commit e7ae3f6babc881d893411a5ada9156abe8525b2f
---
 libfreerdp/core/nla.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/libfreerdp/core/nla.c b/libfreerdp/core/nla.c
index 63966f5..ab9bfb3 100644
--- a/libfreerdp/core/nla.c
+++ b/libfreerdp/core/nla.c
@@ -1541,15 +1541,19 @@ BOOL nla_send(rdpNla* nla)
 int nla_decode_ts_request(rdpNla* nla, wStream* s)
 {
 	int length;
+	UINT32 version;
 
 	/* TSRequest */
 	if (!ber_read_sequence_tag(s, &length) ||
 	    !ber_read_contextual_tag(s, 0, &length, TRUE) ||
-	    !ber_read_integer(s, &nla->version))
+	    !ber_read_integer(s, &version))
 	{
 		return -1;
 	}
 
+	if (version < nla->version)
+		nla->version = version;
+
 	/* [1] negoTokens (NegoData) */
 	if (ber_read_contextual_tag(s, 1, &length, TRUE) != FALSE)
 	{
-- 
2.11.0

